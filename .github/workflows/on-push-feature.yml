name: Push on Feature Branch

on: 
    push:
        branches:
            - '**'
            - '!main'

jobs:
    feature-push:
        name: Build
        runs-on: ubuntu-24.04
        steps:
            - name: Get the artifact version
              id: versions
              uses: keeonline/gh-actions/actions/artifact-version@v0.0.2

            - name: Build the application
              uses: keeonline/gh-actions/actions/java-build@feature-refactor
              with:
                artifact_version: ${{steps.versions.outputs.branch}}

            - name: Package the application as an image
              uses: keeonline/gh-actions/actions/docker-build@feature-refactor
              with:
                image: chameleon
                artifact_version: ${{steps.versions.outputs.branch}}
            
            - name: Setup docker compose
              uses: keeonline/gh-actions/actions/setup-docker-compose@feature-refactor
              with:
                version: 2.39.1

            - name: Set environment variables for service startup
              working-directory: servicetest/karate
              run: |
                echo "VERSION=${{steps.versions.outputs.branch}}" >> .env
                cat .env

            - name: Start the chameleon service
              working-directory: servicetest/karate
              run: |
                docker-compose up -d
                sleep 5

            - name: Setup karate
              run: |
                wget -O /opt/karate.jar https://github.com/karatelabs/karate/releases/download/v1.5.1/karate-1.5.1.jar

            - name: Execute karate tests
              working-directory: servicetest/karate
              run: |
                java -jar /opt/karate.jar .

            - name: Upload service test reports
              uses: actions/upload-artifact@v4
              with:
                name: Service Test Reports
                path: servicetest/karate/target/karate-reports

            - name: Stop the chameleon service
              if: always()
              working-directory: servicetest
              run: |
                docker-compose down

            - name: Publish the image
              uses: keeonline/gh-actions/actions/setup-docker-compose@feature-refactor
              with:
                username: ${{vars.DOCKERHUB_USERNAME}}
                password: ${{secrets.DOCKERHUB_TOKEN}}
                source_image: chameleon:${{steps.versions.outputs.branch}}
                target_image: ${{vars.DOCKERHUB_USERNAME}}/chameleon:${{steps.versions.outputs.branch}}
